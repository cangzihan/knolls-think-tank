# 金融大数据分析

通过这门课程，你将了解到： 
1. Python编程的基础知识 
2. 使用python进行金融数据分析的实战技能 
3. 大量有业务价值的分析案例和源代码 
4. 相关的金融概念和知识 

方法： 
- 每节课讲解数据分析的实战案例，同时讲解使用的python知识点 
- 提供样例代码，供学习时练习 
- 最后提供作业 

## 1. Python金融数据
### 为什么使用Python做金融分析？ 
1. Python语言非常简单，易学，适合初学者作为入门语言 
    Python.的语法简单，代码可读性高，容易入门，有利于初学者学习。即使没有学过，看代码也能猜出要干什么。 

2. Python拥有一个巨大而活跃的科学计算社区 
    Python在数据分析和交互，探索性计算及数据可视化等方面都有非常成熟的库和活跃的社区，使python成为数据处理任务的重要解决方案。 

    在科学计算方面，Python拥有NumPy, pandas, Matplotlib, scikit learn,等一系列非常优秀的库和工具。 

## 2. 金融数据获取
### 2.1 使用tushare获取数据
Tushare 是一个免费、开源的Python财经数据接口包。主要实现对股票等金融数据从数据采集、清洗加工 到 数据存储的过程，能够为金融分析人员提供快速、整洁、和多样的便于分析的数据。


通过简单的接口调用可获取相应的DataFrame格式数据，主要包括以下类别：
- 历史行情数据
- 复权历史数据
- 实时行情数据
- 历史分笔数据
- 实时报价数据
- 当日历史分笔
- 大盘指数列表
- 大单交易数据

#### 安装
在命令行中输入`pip install tushare`

#### Python代码
[官方文档](https://tushare.pro/document/2)

```python
# 导入 tushare库
import tushare as ts

# 获取历史日行情
df = ts.get_hist_data(
    '600030',
    start='2021-01-01',
    end='2021-01-31'
)
df
```

关于get_hist_data（）方法
参数说明：
- code：股票代码，即6位数字代码，或者指数代码
    （sh=上证指数 sz=深圳成指 hs300=沪深300指数 sz50=上证50 zxb=中小板 cyb=创业板）
- start：开始日期，格式YYYY-MM-DD
- end：结束日期，格式YYYY-MM-DD
- ktype：数据类型，D=日k线 W=周 M=月 5=5分钟 15=15分钟 30=30分钟 60=60分钟，默认为D

返回值说明：
- date：日期
- open：开盘价
- high：最高价
- close：收盘价
- low：最低价
- volume：成交量
- price_change：价格变动
- p_change：涨跌幅
- ma5：5日均价
- ma10：10日均价
- ma20:20日均价
- v_ma5:5日均量
- v_ma10:10日均量
- v_ma20:20日均量
- turnover:换手率

### 2.2 使用爬虫获取数据
网络爬虫（又被称为网页蜘蛛，网络机器人，在FOAF社区中间，更经常的称为网页追逐者），是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本。

#### 网络爬虫基本步骤
1. 模拟发起HTTP请求
2. 接收服务器返回的数据
3. 解析数据，提取有效内容
4. 将内容保存到数据库中

#### 如何模拟发起HTTP请求？
1. 通过浏览器访问数据站点
2. 分析通信包格式和请求参数（F12）
3. 通过爬虫模拟发起请求，如果能正确收到应答，则模拟成功

| 三方库 | 作用 |
| :---: | :---: |
| requests | 模拟发起http请求，接受服务器返回的数据 |
| json | 解析json数据 |
| bs4 | 解析HTML数据 |

## 4. 金融数据的显示（下）
### K线图
在股市中K线被用作记录当天的价格变化，一条K线代表当天的价格走势，多个K线在一起就形成了K线图，代表多日的价格变化。

根据每只股票当日开盘价、收盘价、最高价及最低价四项数据，可以将股价走势图分成三种，即阳线、阴线和十字线。在这三种线上延伸的线段又分别称为上影线和下影线。

```python
import tushare as ts
import matplotlib.pyplot as plt
import mpl_finance as mpf
import numpy as np

# acquire data
data = ts.get_k_data('600519', ktype='D', autype='qfq', start='2018-12-01', end='')

# prepare data
prices = data[['open', 'high', 'low', 'close']]
dates = data['date']
candleData = np.column_stack([list(range(len(dates))), prices])

# plot figure
fig = plt.figure(figsize=(10, 6))
ax = fig.add_axes([0.1, 0.3, 0.8, 0.6])
mpf.candlestick_ohlc(ax, candleData, width=0.5, colorup='r', colordown='b')
plt.show()
```


## 5. 金融数据的存储
### 5.1 通过csv和excel存储数据
```python
# save to csv
df.to_csv('daily_399001_2.csv')

# save to excel
# pip install xlwt
df.to_excel('daily_399001_2.xls', 'close_price')

```

读取数据
```python
# read from csv
import csv
csv_reader = csv.DictReader(open('daily_399001_2.csv', 'r'))
for record in csv_reader:
    print(record['trade_date'], record['close'], record['freq'],record['symbol'])

# read from excel
import xlrd
workbook = xlrd.open_workbook('daily_399001_2.xls')
sheet = workbook.sheet_by_name('close_price')

# 遍历整个sheet
for i in range(sheet.nrows):
    list_row = []
    for j in range(sheet.ncols):
        list_row.append(sheet.cell(i,j))

```
#### 通过pandas读取数据
```python
# read csv by pandas
import pandas as pd
df2 = pd.read_csv('daily_399001_2.csv')

# read excel by pandas
import pandas as pd
df2 = pd.read_excel('daily_399001_2.xls')
```

### 5.2 使用数据库存储数据
除了使用csv、excel文件存储数据外，还可通过数据库保存获得的数据，目前常用的支持python的数据库有
- PostgreSQL数据库
- Mysql数据库
- Mongodb数据库
- Cassandra数据库
- Redis数据库

有关python支持的数据库清单:

https://wiki.python.org/moin/DatabaseInterfaces

#### 通过MySQL存储数据
MySQL 为关系型数据库(Relational Database Management System), 这种所谓的“关系型”可以理解为“表格”的概念, 一个关系型数据库由一个或数个表格组成。
- 表头(header): 每一列的名称;
- 列(col): 具有相同数据类型的数据的集合;
- 行(row): 每一行用来描述某条记录的具体信息;
- 值(value): 行的具体信息, 每个值必须与该列的数据类型相同;
- 键(key): 键的值在当前列中具有唯一性。

MySQL 连接
从命令行中连接mysql服务器的简单实例：
```shell
mysql –u [username] –p [password]

#例如
mysql –u root –p 123456
```

MySQL 创建数据库

连接成功后输入以下命令创建一个新数据库`create database pytest;`

访问某一数据库：`use [数据库名]; `

MySQL 创建数据表

在新数据库下通过以下命令创建一个新数据表:
```shell
create table daily_info ( 
    trade_date int, 
    close_price decimal(10,2), 
    freq varchar(10), 
    symbol varchar(32) 
);
```

查看当前库下面的表：`show tables;`

其他操作
- 删库: `drop database [数据库名];`
- 删除表: 
    - `drop table [数据表名];`
    - `truncate table [数据表名];`
    - `delete  from [数据表名];`
- 数据表改名:
    - rename table [表名] to [新表名]
- 插入数据:
    ```shell
    insert into [数据表名]  values
    (value1, value2, value3, … ,valueN);
    ```
    往哪张表添加？给哪几列添加值？分别是什么值？
- 数据库不能改名

Python通过MySQL存储数据
```python
import MySQLdb
conn = MySQLdb.connect( 
    "127.0.0.1", 'root', '123456', 
    ‘pytest', 3306, 'utf8' 
)

# begin a transaction
conn.begin()

# read from csv
import csv
csv_reader = csv.DictReader(open('daily_399001_2.csv', 'r'))

cursor = conn.cursor()
for record in csv_reader:
    trade_date  = int(record['trade_date'])
    close_price = float(record['close'])
    freq        = record['freq']
    symbol      = record['symbol']
    sql = "insert into daily_info values (%d, %.2f, '%s', '%s') " \
          % (trade_date,close_price,freq,symbol)
    cursor.execute(sql)

cursor.close()

# commit a transaction
conn.commit()
```

运行后，在命令行中输入`select * from daily_info`即可查看存储进去的数据

数据读取
1. 按照位置访问结果
```python
sql = "select * from daily_info " \
      "where trade_date <= 20180202"

cursor = conn.cursor()
cursor.execute(sql)

records = cursor.fetchall()
for record in records:
    print(record)
```

2.  按照列访问结果
```python
sql = "select * from daily_info " \
      "where trade_date <= 20180202"

cursor = conn.cursor(MySQLdb.cursors.DictCursor)
cursor.execute(sql)

records = cursor.fetchall()
for record in records:
    print(record)
```

#### 常用语法
- 排序：
    - `Select * From 【表】 Order by 【字段】`
    - `Select index, mount From SheetA Order by mount desc` 其中最后`asc`和`desc`分别控制排序方向。
- 分组：
    - `Select min(mount),categoryID From SheetA Group by categoryID`

#### 聚合运算
语法：`Select min(Col) From Table_name`

支持的聚合运算有：Min / Max / Count / Sum / Avg

能在 MySQL 里聚合的，就尽量在 MySQL 里做。Pandas 聚合适合数据量较小、逻辑复杂、或需灵活处理的情况。

| 比较维度             | MySQL 聚合（数据库侧）              | Pandas 聚合（Python侧）     |
| ---------------- | --------------------------- | ---------------------- |
| **性能**           | ✅ 更快。数据库聚合在存储层执行，有索引优化、查询计划 | ❌ 较慢。需先拉取全部数据到内存再计算    |
| **内存占用**         | ✅ 低。仅传输聚合结果                 | ❌ 高。所有原始数据需加载到内存       |
| **数据量**          | ✅ 可轻松处理千万级数据                | ❌ 通常受限于本地内存（百万级以上会卡）   |
| **复杂逻辑（如自定义函数）** | ❌ SQL不适合复杂业务逻辑              | ✅ Pandas可用Python函数灵活计算 |
| **易维护性**         | ✅ SQL语句直观、可直接在DB测试          | ⚠️ Python逻辑复杂但可读性强     |
| **可复用性**         | ✅ 聚合结果可直接给其他程序使用            | ❌ 通常是脚本内局部计算结果         |
| **开发效率**         | ⚖️ SQL简洁但语法限制多              | ⚖️ Pandas语法灵活但调试耗时     |

最常见、最实用的模式是：
- 在 MySQL 做「初步聚合」或筛选，
- 再在 Pandas 做「二次处理」或复杂分析。

📘 例如：
```sql
SELECT user_id, AVG(score) AS avg_score, COUNT(*) AS num
FROM exam_records
WHERE exam_date > '2024-01-01'
GROUP BY user_id;
```
Python 再：
```python
df = pd.read_sql(query, conn)
df['score_level'] = df['avg_score'].apply(lambda x: 'A' if x > 90 else 'B')

```

| 场景        | 推荐做法                    |
| --------- | ----------------------- |
| 数据量大、逻辑简单 | **MySQL 聚合**            |
| 数据量小、逻辑复杂 | **Pandas 聚合**           |
| 既要效率又要灵活  | **SQL 初筛 + Pandas 后处理** |


## 8. 金融数据中的随机数
### 期权
期权，是指一种合约，该合约赋予持有人在某一特定日期或该日之前的任何时间以固定价格购进或售出一种资产的权利。

其基本类型为欧式期权与美式期权:
- 美式期权(American options)是指允许期权的持有人在期权的有效期的到期日之前任何一天均可履行合约的期权。
- 欧式期权(European options)是指仅允许期权的持有人在期权的有效期最后一天方可履行合约的期权。
       无论是欧式期权还是美式期权只是名称不同，并无任何地理上的意义。由于美式期权比欧洲式期权具有更大的回旋余地，通常更具有价值。

- 看涨期权是估计这个股票会涨，可以在未来以一定的价格买进。
- 看跌期权是估计股价会跌，可以在未来以一定价格卖出。
#### Black-Scholes-Merton 模型
一个改变世界的偏微分方程【BSM偏微分方程(PDE)，1973】

为什么该方程被广泛接受？
1. 对于价值V仅依赖于S和t的每个未定权益，该方程都成立，因此这个方程非常重要。
2. 该PDR提供了欧式看涨期权和看跌期权的显式解（解析解）。


